{% extends "base.html" %}

{% block title %}{{ group.name }} - Group Chat{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/folklore.css') }}">
{% endblock %}

{% block content %}
<div class="page-reveal">
    <!-- Cultural Header -->
    <div class="text-center mb-4">
        <h2 class="folklore-heading">{{ group.name }}</h2>
        <p class="folklore-body">{{ tradition_icon }} {{ tradition_name }} Gathering Place</p>
    </div>

    <div class="adinkra-divider">
        <span class="adinkra-symbol">‚ú¶</span>
    </div>

    <div class="row">
        <!-- Main Chat Area -->
        <div class="col-lg-8 mb-4">
            <div class="parchment-card stagger-reveal">
                <h3 class="folklore-subheading mb-3">üìú Story Circle</h3>
                
                <!-- Message Scroll Container -->
                <div class="message-scroll" id="messageContainer">
                    <div id="messages">
                        {% for message in messages %}
                        <div class="message-bubble {% if message.is_proverb %}proverb{% endif %} {% if message.user.memberships|selectattr('group_id', 'equalto', group.id)|selectattr('is_storyteller', 'equalto', True)|list %}storyteller{% endif %} ink-flow">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--earth-gradient); display: flex; align-items: center; justify-content: center; color: var(--parchment); font-weight: bold; border: 2px solid var(--earth-brown);">
                                        {{ message.user.username[0].upper() }}
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <strong class="folklore-subheading" style="font-size: 1rem;">{{ message.user.username }}</strong>
                                        {% set member = message.user.memberships|selectattr('group_id', 'equalto', group.id)|first %}
                                        {% if member and member.is_storyteller %}
                                        <span class="ms-2" style="background: var(--gold); color: var(--ink); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold;">STORYTELLER</span>
                                        {% endif %}
                                        <small class="text-muted ms-auto" style="font-size: 0.75rem;">{{ message.created_at.strftime('%I:%M %p') }}</small>
                                    </div>
                                    
                                    {% if message.is_proverb %}
                                    <div class="proverb-text mt-2">
                                        {{ message.content }}
                                    </div>
                                    {% if message.proverb_context %}
                                    <p class="folklore-body small text-muted mt-2 ms-4">
                                        <em>Meaning:</em> {{ message.proverb_context }}
                                    </p>
                                    {% endif %}
                                    {% else %}
                                    <p class="folklore-body mb-2">{{ message.content }}</p>
                                    {% endif %}
                                    
                                    <!-- Cultural Reactions -->
                                    <div class="mt-2">
                                        {% for reaction_type in ['harvest', 'drum', 'light', 'hands', 'wisdom', 'celebration'] %}
                                        <span class="cultural-reaction reaction-{{ reaction_type }}" 
                                              onclick="addReaction({{ message.id }}, '{{ reaction_type }}')">
                                            <span class="ms-1 small">{{ message.reactions|selectattr('emoji', 'equalto', reaction_type)|list|length or '' }}</span>
                                        </span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Message Input -->
                <div class="mt-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="proverbCheck">
                        <label class="form-check-label folklore-body" for="proverbCheck">
                            üìú Share as Proverb/Wisdom
                        </label>
                    </div>
                    
                    <div class="input-group">
                        <input type="text" 
                               id="messageInput" 
                               class="form-control folklore-body" 
                               placeholder="Share your story..."
                               style="border: 2px solid var(--earth-brown); border-radius: 8px 0 0 8px; padding: 0.75rem;">
                        <button class="btn-folklore" 
                                onclick="sendMessage()" 
                                style="border-radius: 0 8px 8px 0;">
                            Send
                        </button>
                    </div>
                    
                    <div id="proverbContextDiv" style="display: none;" class="mt-2">
                        <input type="text" 
                               id="proverbContext" 
                               class="form-control folklore-body" 
                               placeholder="Explain the meaning..."
                               style="border: 2px solid var(--gold); border-radius: 8px; padding: 0.75rem;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar: Members & Info -->
        <div class="col-lg-4">
            <!-- Proverb Library -->
            <div class="parchment-card mb-4 gentle-lift">
                <h4 class="folklore-subheading mb-3">üìö Proverb Library</h4>
                <div class="folklore-body small">
                    <p class="proverb-text" style="font-size: 0.95rem;">
                        {{ proverbs[0] if proverbs else "Unity is strength, division is weakness." }}
                    </p>
                    <button class="btn-folklore btn-sm mt-2" onclick="loadNewProverb()">
                        ‚ú¶ Another Wisdom
                    </button>
                </div>
            </div>

            <!-- Circle Members -->
            <div class="parchment-card gentle-lift">
                <h4 class="folklore-subheading mb-3">üë• Circle Members</h4>
                <div class="stagger-reveal">
                    {% for member in members %}
                    <div class="d-flex align-items-center mb-3 ink-flow" style="padding: 0.5rem; background: rgba(212, 163, 115, 0.1); border-radius: 8px; border-left: 3px solid var(--earth-brown);">
                        <div style="width: 35px; height: 35px; border-radius: 50%; background: var(--sunset-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9rem;">
                            {{ member.user.username[0].upper() }}
                        </div>
                        <div class="ms-2 flex-grow-1">
                            <div class="folklore-subheading" style="font-size: 0.9rem;">{{ member.user.username }}</div>
                            {% if member.is_storyteller %}
                            <small style="color: var(--gold); font-weight: bold;">‚ú¶ Storyteller</small>
                            {% elif member.role == 'admin' %}
                            <small style="color: var(--terracotta);">‚óè Circle Keeper</small>
                            {% else %}
                            <small class="text-muted">Member</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Socket.IO for Real-time Chat -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    const groupId = {{ group.id }};
    const userId = {{ current_user_id }};

    // Join this group's room
    socket.on('connect', function() {
        socket.emit('join_group', {group_id: groupId});
        console.log('Connected to group chat');
    });

    // Receive new messages
    socket.on('new_message', function(data) {
        if (data.group_id === groupId) {
            appendMessage(data);
        }
    });

    // Send message
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        const isProverb = document.getElementById('proverbCheck').checked;
        const proverbContext = document.getElementById('proverbContext').value;

        if (message) {
            socket.emit('send_message', {
                group_id: groupId,
                content: message,
                is_proverb: isProverb,
                proverb_context: isProverb ? proverbContext : null
            });
            input.value = '';
            document.getElementById('proverbContext').value = '';
        }
    }

    // Append message to UI
    function appendMessage(data) {
        const messagesDiv = document.getElementById('messages');
        const messageHtml = `
            <div class="message-bubble ${data.is_proverb ? 'proverb' : ''} ${data.is_storyteller ? 'storyteller' : ''} ink-flow">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-3">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--earth-gradient); display: flex; align-items: center; justify-content: center; color: var(--parchment); font-weight: bold; border: 2px solid var(--earth-brown);">
                            ${data.username[0].toUpperCase()}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <strong class="folklore-subheading" style="font-size: 1rem;">${data.username}</strong>
                            ${data.is_storyteller ? '<span class="ms-2" style="background: var(--gold); color: var(--ink); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold;">STORYTELLER</span>' : ''}
                            <small class="text-muted ms-auto" style="font-size: 0.75rem;">${new Date().toLocaleTimeString()}</small>
                        </div>
                        ${data.is_proverb ? `
                            <div class="proverb-text mt-2">${data.content}</div>
                            ${data.proverb_context ? `<p class="folklore-body small text-muted mt-2 ms-4"><em>Meaning:</em> ${data.proverb_context}</p>` : ''}
                        ` : `<p class="folklore-body mb-2">${data.content}</p>`}
                    </div>
                </div>
            </div>
        `;
        messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
        document.getElementById('messageContainer').scrollTop = document.getElementById('messageContainer').scrollHeight;
    }

    // Add reaction
    function addReaction(messageId, emoji) {
        socket.emit('add_reaction', {
            message_id: messageId,
            emoji: emoji
        });
    }

    // Toggle proverb context input
    document.getElementById('proverbCheck').addEventListener('change', function() {
        document.getElementById('proverbContextDiv').style.display = this.checked ? 'block' : 'none';
    });

    // Enter key to send
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Load new proverb
    function loadNewProverb() {
        fetch('/api/random-proverb')
            .then(r => r.json())
            .then(data => {
                document.querySelector('.proverb-text').textContent = data.proverb;
            });
    }
</script>
{% endblock %}
