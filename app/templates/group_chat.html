{% extends "base.html" %}

{% block title %}{{ group.name }} - Group Chat{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/folklore.css') }}">
{% endblock %}

{% block content %}
<div class="page-reveal">
    <!-- Cultural Header -->
    <div class="text-center mb-4">
        <h2 class="folklore-heading">{{ group.name }}</h2>
        <p class="folklore-body">{{ tradition_icon }} {{ tradition_name }} Gathering Place</p>
    </div>

    <div class="adinkra-divider">
        <span class="adinkra-symbol">‚ú¶</span>
    </div>

    <div class="row">
        <!-- Main Chat Area -->
        <div class="col-lg-8 mb-4">
            <div class="parchment-card stagger-reveal">
                <h3 class="folklore-subheading mb-3">üìú Story Circle</h3>
                
                <!-- Message Scroll Container -->
                <div class="message-scroll" id="messageContainer">
                    <div id="messages">
                        {% for message in messages %}
                        <div class="message-bubble {% if message.is_proverb %}proverb{% endif %} {% if message.user.memberships|selectattr('group_id', 'equalto', group.id)|selectattr('is_storyteller', 'equalto', True)|list %}storyteller{% endif %} ink-flow">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--earth-gradient); display: flex; align-items: center; justify-content: center; color: var(--parchment); font-weight: bold; border: 2px solid var(--earth-brown);">
                                        {{ message.user.username[0].upper() }}
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <strong class="folklore-subheading" style="font-size: 1rem;">{{ message.user.username }}</strong>
                                        {% set member = message.user.memberships|selectattr('group_id', 'equalto', group.id)|first %}
                                        {% if member and member.is_storyteller %}
                                        <span class="ms-2" style="background: var(--gold); color: var(--ink); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold;">STORYTELLER</span>
                                        {% endif %}
                                        <small class="text-muted ms-auto" style="font-size: 0.75rem;">{{ message.created_at.strftime('%I:%M %p') }}</small>
                                    </div>
                                    
                                    {% if message.message_type == 'audio' and message.audio_url %}
                                    <div class="audio-message">
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <span>üé§</span>
                                            <span class="folklore-body small">Voice Message{% if message.audio_duration %} ({{ message.audio_duration|int }}s){% endif %}</span>
                                        </div>
                                        <audio controls src="{{ message.audio_url }}" style="width: 100%; height: 36px;"></audio>
                                    </div>
                                    {% elif message.is_proverb %}
                                    <div class="proverb-text mt-2">
                                        {{ message.content }}
                                    </div>
                                    {% if message.proverb_context %}
                                    <p class="folklore-body small text-muted mt-2 ms-4">
                                        <em>Meaning:</em> {{ message.proverb_context }}
                                    </p>
                                    {% endif %}
                                    {% else %}
                                    <p class="folklore-body mb-2">{{ message.content }}</p>
                                    {% endif %}
                                    
                                    <!-- Cultural Reactions -->
                                    <div class="mt-2">
                                        {% for reaction_type in ['harvest', 'drum', 'light', 'hands', 'wisdom', 'celebration'] %}
                                        <span class="cultural-reaction reaction-{{ reaction_type }}" 
                                              onclick="addReaction({{ message.id }}, '{{ reaction_type }}')">
                                            <span class="ms-1 small">{{ message.reactions|selectattr('emoji', 'equalto', reaction_type)|list|length or '' }}</span>
                                        </span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Message Input -->
                <div class="mt-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="proverbCheck">
                        <label class="form-check-label folklore-body" for="proverbCheck">
                            üìú Share as Proverb/Wisdom
                        </label>
                    </div>
                    
                    <div class="input-group">
                        <input type="text" 
                               id="messageInput" 
                               class="form-control folklore-body" 
                               placeholder="Share your story..."
                               style="border: 2px solid var(--earth-brown); border-radius: 8px 0 0 8px; padding: 0.75rem;">
                        <button class="btn-folklore" 
                                onclick="sendMessage()" 
                                style="border-radius: 0 8px 8px 0;">
                            Send
                        </button>
                    </div>
                    
                    <div id="proverbContextDiv" style="display: none;" class="mt-2">
                        <input type="text" 
                               id="proverbContext" 
                               class="form-control folklore-body" 
                               placeholder="Explain the meaning..."
                               style="border: 2px solid var(--gold); border-radius: 8px; padding: 0.75rem;">
                    </div>
                    
                    <!-- Audio Recording -->
                    <div class="mt-3 d-flex align-items-center gap-2">
                        <button id="recordBtn" class="btn-folklore d-flex align-items-center gap-2" onclick="toggleRecording()">
                            <span id="recordIcon">üé§</span>
                            <span id="recordText">Voice Message</span>
                        </button>
                        <div id="recordingStatus" style="display: none;" class="d-flex align-items-center gap-2">
                            <span class="recording-dot"></span>
                            <span id="recordingTime" class="folklore-body">0:00</span>
                        </div>
                        <audio id="audioPreview" style="display: none;" controls></audio>
                        <button id="sendAudioBtn" class="btn-folklore" style="display: none;" onclick="sendAudioMessage()">
                            Send Audio
                        </button>
                        <button id="cancelAudioBtn" class="btn btn-outline-secondary btn-sm" style="display: none;" onclick="cancelRecording()">
                            ‚úï
                        </button>
                    </div>
                </div>
                
                <style>
                    .recording-dot {
                        width: 12px;
                        height: 12px;
                        background: #ff4444;
                        border-radius: 50%;
                        animation: pulse-recording 1s infinite;
                    }
                    @keyframes pulse-recording {
                        0%, 100% { opacity: 1; transform: scale(1); }
                        50% { opacity: 0.5; transform: scale(1.2); }
                    }
                    .audio-message {
                        background: linear-gradient(135deg, rgba(255, 159, 28, 0.1), rgba(46, 196, 182, 0.1));
                        border-radius: 12px;
                        padding: 0.75rem;
                        margin-top: 0.5rem;
                    }
                    .audio-message audio {
                        width: 100%;
                        height: 36px;
                    }
                </style>
            </div>
        </div>

        <!-- Sidebar: Members & Info -->
        <div class="col-lg-4">
            <!-- Proverb Library -->
            <div class="parchment-card mb-4 gentle-lift">
                <h4 class="folklore-subheading mb-3">üìö Proverb Library</h4>
                <div class="folklore-body small">
                    <p class="proverb-text" style="font-size: 0.95rem;">
                        {{ proverbs[0] if proverbs else "Unity is strength, division is weakness." }}
                    </p>
                    <button class="btn-folklore btn-sm mt-2" onclick="loadNewProverb()">
                        ‚ú¶ Another Wisdom
                    </button>
                </div>
            </div>

            <!-- Circle Members -->
            <div class="parchment-card gentle-lift">
                <h4 class="folklore-subheading mb-3">üë• Circle Members</h4>
                <div class="stagger-reveal">
                    {% for member in members %}
                    <div class="d-flex align-items-center mb-3 ink-flow" style="padding: 0.5rem; background: rgba(212, 163, 115, 0.1); border-radius: 8px; border-left: 3px solid var(--earth-brown);">
                        <div style="width: 35px; height: 35px; border-radius: 50%; background: var(--sunset-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9rem;">
                            {{ member.user.username[0].upper() }}
                        </div>
                        <div class="ms-2 flex-grow-1">
                            <div class="folklore-subheading" style="font-size: 0.9rem;">{{ member.user.username }}</div>
                            {% if member.is_storyteller %}
                            <small style="color: var(--gold); font-weight: bold;">‚ú¶ Storyteller</small>
                            {% elif member.role == 'admin' %}
                            <small style="color: var(--terracotta);">‚óè Circle Keeper</small>
                            {% else %}
                            <small class="text-muted">Member</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Socket.IO for Real-time Chat -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    const groupId = {{ group.id }};
    const userId = {{ current_user_id }};

    // Join this group's room
    socket.on('connect', function() {
        socket.emit('join_group', {group_id: groupId});
        console.log('Connected to group chat');
    });

    // Receive new messages
    socket.on('new_message', function(data) {
        if (data.group_id === groupId) {
            appendMessage(data);
        }
    });

    // Send message
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        const isProverb = document.getElementById('proverbCheck').checked;
        const proverbContext = document.getElementById('proverbContext').value;

        if (message) {
            socket.emit('send_message', {
                group_id: groupId,
                content: message,
                is_proverb: isProverb,
                proverb_context: isProverb ? proverbContext : null
            });
            input.value = '';
            document.getElementById('proverbContext').value = '';
        }
    }

    // Append message to UI
    function appendMessage(data) {
        const messagesDiv = document.getElementById('messages');
        const messageHtml = `
            <div class="message-bubble ${data.is_proverb ? 'proverb' : ''} ${data.is_storyteller ? 'storyteller' : ''} ink-flow">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-3">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--earth-gradient); display: flex; align-items: center; justify-content: center; color: var(--parchment); font-weight: bold; border: 2px solid var(--earth-brown);">
                            ${data.username[0].toUpperCase()}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <strong class="folklore-subheading" style="font-size: 1rem;">${data.username}</strong>
                            ${data.is_storyteller ? '<span class="ms-2" style="background: var(--gold); color: var(--ink); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold;">STORYTELLER</span>' : ''}
                            <small class="text-muted ms-auto" style="font-size: 0.75rem;">${new Date().toLocaleTimeString()}</small>
                        </div>
                        ${data.is_proverb ? `
                            <div class="proverb-text mt-2">${data.content}</div>
                            ${data.proverb_context ? `<p class="folklore-body small text-muted mt-2 ms-4"><em>Meaning:</em> ${data.proverb_context}</p>` : ''}
                        ` : `<p class="folklore-body mb-2">${data.content}</p>`}
                    </div>
                </div>
            </div>
        `;
        messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
        document.getElementById('messageContainer').scrollTop = document.getElementById('messageContainer').scrollHeight;
    }

    // Add reaction
    function addReaction(messageId, emoji) {
        socket.emit('add_reaction', {
            message_id: messageId,
            emoji: emoji
        });
    }

    // Toggle proverb context input
    document.getElementById('proverbCheck').addEventListener('change', function() {
        document.getElementById('proverbContextDiv').style.display = this.checked ? 'block' : 'none';
    });

    // Enter key to send
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Load new proverb
    function loadNewProverb() {
        fetch('/api/random-proverb')
            .then(r => r.json())
            .then(data => {
                document.querySelector('.proverb-text').textContent = data.proverb;
            });
    }

    // ============== AUDIO RECORDING ==============
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = null;
    let recordingTimer = null;
    let currentAudioBlob = null;

    async function toggleRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            stopRecording();
        } else {
            await startRecording();
        }
    }

    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                currentAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(currentAudioBlob);
                document.getElementById('audioPreview').src = audioUrl;
                document.getElementById('audioPreview').style.display = 'block';
                document.getElementById('sendAudioBtn').style.display = 'inline-block';
                document.getElementById('cancelAudioBtn').style.display = 'inline-block';
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            recordingStartTime = Date.now();
            
            document.getElementById('recordIcon').textContent = '‚èπÔ∏è';
            document.getElementById('recordText').textContent = 'Stop';
            document.getElementById('recordBtn').style.background = 'linear-gradient(135deg, #ff4444, #cc0000)';
            document.getElementById('recordingStatus').style.display = 'flex';
            
            recordingTimer = setInterval(updateRecordingTime, 1000);
        } catch (err) {
            console.error('Microphone access denied:', err);
            alert('Please allow microphone access to send voice messages.');
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            clearInterval(recordingTimer);
            
            document.getElementById('recordIcon').textContent = 'üé§';
            document.getElementById('recordText').textContent = 'Voice Message';
            document.getElementById('recordBtn').style.background = '';
            document.getElementById('recordingStatus').style.display = 'none';
        }
    }

    function updateRecordingTime() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        document.getElementById('recordingTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function cancelRecording() {
        currentAudioBlob = null;
        document.getElementById('audioPreview').style.display = 'none';
        document.getElementById('sendAudioBtn').style.display = 'none';
        document.getElementById('cancelAudioBtn').style.display = 'none';
        document.getElementById('audioPreview').src = '';
    }

    async function sendAudioMessage() {
        if (!currentAudioBlob) return;
        
        const formData = new FormData();
        formData.append('audio', currentAudioBlob, 'voice_message.webm');
        
        try {
            const response = await fetch('/api/audio/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if (data.success) {
                const duration = (Date.now() - recordingStartTime) / 1000;
                socket.emit('send_audio_message', {
                    group_id: groupId,
                    audio_url: data.audio_url,
                    duration: duration
                });
                cancelRecording();
            } else {
                alert('Failed to upload audio: ' + (data.error || 'Unknown error'));
            }
        } catch (err) {
            console.error('Error uploading audio:', err);
            alert('Error sending voice message. Please try again.');
        }
    }

    // Handle incoming audio messages
    socket.on('new_audio_message', function(data) {
        if (data.group_id === groupId) {
            appendAudioMessage(data);
        }
    });

    function appendAudioMessage(data) {
        const messagesDiv = document.getElementById('messages');
        const duration = data.duration ? Math.round(data.duration) : 0;
        const messageHtml = `
            <div class="message-bubble ${data.is_storyteller ? 'storyteller' : ''} ink-flow">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-3">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--earth-gradient); display: flex; align-items: center; justify-content: center; color: var(--parchment); font-weight: bold; border: 2px solid var(--earth-brown);">
                            ${data.username[0].toUpperCase()}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <strong class="folklore-subheading" style="font-size: 1rem;">${data.username}</strong>
                            ${data.is_storyteller ? '<span class="ms-2" style="background: var(--gold); color: var(--ink); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold;">STORYTELLER</span>' : ''}
                            <small class="text-muted ms-auto" style="font-size: 0.75rem;">${new Date().toLocaleTimeString()}</small>
                        </div>
                        <div class="audio-message">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <span>üé§</span>
                                <span class="folklore-body small">Voice Message (${duration}s)</span>
                            </div>
                            <audio controls src="${data.audio_url}" style="width: 100%; height: 36px;"></audio>
                        </div>
                    </div>
                </div>
            </div>
        `;
        messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
        document.getElementById('messageContainer').scrollTop = document.getElementById('messageContainer').scrollHeight;
    }
</script>
{% endblock %}
