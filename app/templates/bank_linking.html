{% extends "base.html" %}

{% block title %}Link Bank Account - TiK√≤b{% endblock %}

{% block content %}
<div class="hero-lakou depth-shadow mb-4 animate-in" data-aos="fade-down">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <h1 class="hero-title mb-2">
                {% if language == 'ht' %}Konekte Kont Bank Ou{% else %}Link Your Bank Account{% endif %}
            </h1>
            <div class="pwov√®b mb-0">
                {{ proverb.text }}
                {% if proverb.meaning %}
                    <span class="pwov√®b-meaning">{{ proverb.meaning }}</span>
                {% endif %}
            </div>
        </div>
        <div class="col-lg-4 text-center d-none d-lg-block">
            <div style="font-size: 5rem;">üè¶</div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="immersive-card depth-shadow mb-4" data-aos="fade-up">
            <h5 class="lakou-heading mb-3 d-flex align-items-center gap-2">
                <span>üîó</span> {% if language == 'ht' %}Konekte Nouvo Kont{% else %}Connect New Account{% endif %}
            </h5>
            
            <p class="lakou-body mb-4" style="color: var(--text-secondary);">
                {% if language == 'ht' %}
                Konekte kont bank ou an sekirite pou swiv ekonomi ou pi fasil. Nou itilize Teller pou pwoteje enf√≤masyon ou.
                {% else %}
                Securely connect your bank account to easily track your savings. We use Teller to protect your information.
                {% endif %}
            </p>
            
            <div class="text-center py-4">
                {% if teller_app_id %}
                <button id="connectBankBtn" class="btn-konbit btn-konbit-primary btn-lg px-5">
                    <span style="font-size: 1.5rem; margin-right: 0.5rem;">üè¶</span>
                    {% if language == 'ht' %}Konekte Bank{% else %}Connect Bank{% endif %}
                </button>
                <p class="mt-3 small" style="color: var(--text-secondary);">
                    <span style="color: var(--success);">üîí</span> 
                    {% if language == 'ht' %}Koneksyon sekirize ak chifre{% else %}Secure, encrypted connection{% endif %}
                </p>
                {% else %}
                <div class="alert" style="background: rgba(255, 159, 28, 0.1); border: 1px solid var(--mango); border-radius: 12px;">
                    <p class="mb-0 lakou-body">
                        {% if language == 'ht' %}Teller API pa konfigire ank√≤.{% else %}Teller API not configured yet.{% endif %}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="immersive-card depth-shadow" data-aos="fade-up" data-aos-delay="100">
            <h5 class="lakou-heading mb-3 d-flex align-items-center gap-2">
                <span>üìä</span> {% if language == 'ht' %}Kont Konekte yo{% else %}Linked Accounts{% endif %}
            </h5>
            
            <div id="linkedAccountsList">
                {% if linked_accounts %}
                    {% for account in linked_accounts %}
                    <div class="d-flex align-items-center justify-content-between p-3 mb-2" 
                         style="background: rgba(46, 196, 182, 0.08); border-radius: 12px; border: 1px solid rgba(46, 196, 182, 0.2);">
                        <div class="d-flex align-items-center gap-3">
                            <div style="width: 48px; height: 48px; background: var(--ocean-gradient); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                üè¶
                            </div>
                            <div>
                                <div class="lakou-heading" style="font-size: 1rem;">{{ account.institution_name or 'Bank Account' }}</div>
                                <small style="color: var(--text-secondary);">
                                    {{ account.account_type or 'Account' }} 
                                    {% if account.last_four %}‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ account.last_four }}{% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge" style="background: var(--success); color: white;">
                                {% if language == 'ht' %}Aktif{% else %}Active{% endif %}
                            </span>
                            <button class="btn btn-sm btn-outline-danger" onclick="disconnectAccount({{ account.id }})">
                                {% if language == 'ht' %}Dekonekte{% else %}Disconnect{% endif %}
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4" style="color: var(--text-secondary);">
                        <div style="font-size: 3rem; opacity: 0.5; margin-bottom: 1rem;">üè¶</div>
                        <p class="lakou-body mb-0">
                            {% if language == 'ht' %}Ou poko konekte okenn kont bank.{% else %}No bank accounts linked yet.{% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="immersive-card depth-shadow mb-4" data-aos="fade-up" data-aos-delay="200">
            <h5 class="lakou-heading mb-3 d-flex align-items-center gap-2">
                <span>üõ°Ô∏è</span> {% if language == 'ht' %}Sekirite{% else %}Security{% endif %}
            </h5>
            <ul class="list-unstyled lakou-body">
                <li class="mb-2"><span style="color: var(--success);">‚úì</span> {% if language == 'ht' %}Chifre bank-nivo{% else %}Bank-level encryption{% endif %}</li>
                <li class="mb-2"><span style="color: var(--success);">‚úì</span> {% if language == 'ht' %}Nou pa janm w√® modpas ou{% else %}We never see your password{% endif %}</li>
                <li class="mb-2"><span style="color: var(--success);">‚úì</span> {% if language == 'ht' %}Li s√®lman (pa ka f√® tranzaksyon){% else %}Read-only (can't make transactions){% endif %}</li>
                <li><span style="color: var(--success);">‚úì</span> {% if language == 'ht' %}Ou ka dekonekte nenp√≤t l√®{% else %}Disconnect anytime{% endif %}</li>
            </ul>
        </div>
        
        <div class="immersive-card depth-shadow" data-aos="fade-up" data-aos-delay="300">
            <h5 class="lakou-heading mb-3 d-flex align-items-center gap-2">
                <span>üí°</span> {% if language == 'ht' %}Poukisa Konekte?{% else %}Why Connect?{% endif %}
            </h5>
            <ul class="list-unstyled lakou-body small" style="color: var(--text-secondary);">
                <li class="mb-2">üìà {% if language == 'ht' %}Swiv ekonomi ou otomatikman{% else %}Track savings automatically{% endif %}</li>
                <li class="mb-2">üéØ {% if language == 'ht' %}Gade pwogr√® objektif ou{% else %}See goal progress{% endif %}</li>
                <li class="mb-2">üìä {% if language == 'ht' %}Rap√≤ finansye{% else %}Financial reports{% endif %}</li>
                <li>üîî {% if language == 'ht' %}Notifikasyon entelijan{% else %}Smart notifications{% endif %}</li>
            </ul>
        </div>
    </div>
</div>

{% if teller_app_id %}
<script src="https://cdn.teller.io/connect/connect.js"></script>
<script>
    let tellerConnect = null;
    let tellerError = false;
    
    try {
        tellerConnect = TellerConnect.setup({
            applicationId: "{{ teller_app_id }}",
            environment: "{{ teller_environment }}",
            onSuccess: function(enrollment) {
                console.log("Enrollment successful:", enrollment);
                
                fetch('/api/teller/save-enrollment', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        accessToken: enrollment.accessToken,
                        enrollment: enrollment.enrollment
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Bank account linked successfully!', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Error: ' + (data.error || 'Failed to save'), 'error');
                    }
                })
                .catch(err => {
                    console.error('Error saving enrollment:', err);
                    showToast('Connection error. Please try again.', 'error');
                });
            },
            onExit: function() {
                console.log("User exited Teller Connect");
            },
            onFailure: function(error) {
                console.error("Teller Connect error:", error);
                if (error && error.message && error.message.includes('expired')) {
                    showToast('API key expired. Please update in Secrets.', 'error');
                } else {
                    showToast('Connection failed: ' + (error.message || 'Please try again'), 'error');
                }
            }
        });
    } catch (e) {
        console.error("Teller setup error:", e);
        tellerError = true;
        document.getElementById('connectBankBtn').innerHTML = '‚ö†Ô∏è API Key Issue - Update in Secrets';
        document.getElementById('connectBankBtn').style.background = '#dc3545';
    }

    document.getElementById('connectBankBtn').addEventListener('click', function() {
        if (tellerError || !tellerConnect) {
            showToast('Teller API key may be expired. Please update TELLER_APP_ID in Secrets.', 'error');
            return;
        }
        tellerConnect.open();
    });
    
    function disconnectAccount(accountId) {
        if (confirm('Are you sure you want to disconnect this account?')) {
            fetch('/api/teller/disconnect/' + accountId, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Account disconnected', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Error: ' + (data.error || 'Failed'), 'error');
                }
            });
        }
    }
    
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="toast show" role="alert" style="background: ${type === 'success' ? 'var(--success)' : 'var(--error)'}; color: white; border-radius: 12px;">
                <div class="toast-body d-flex align-items-center gap-2">
                    ${type === 'success' ? '‚úì' : '‚úó'} ${message}
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
</script>
{% endif %}
{% endblock %}
